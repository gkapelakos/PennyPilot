name: CI Turbo
on: 
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  metrics:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: subosito/flutter-action@v2
      with:
        cache: true
        channel: stable
    - name: Create secrets.dart
      run: cp lib/src/config/secrets.dart.example lib/src/config/secrets.dart
      shell: bash
    - run: flutter analyze
    - run: dart format --set-exit-if-changed .

  test-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: 
        - {name: "unit-core", path: "test"}
        - {name: "widgets", path: "test"} 
        - {name: "integration", path: "test"}
    steps:
    - uses: actions/checkout@v4
    - uses: subosito/flutter-action@v2
      with: {cache: true}
    - name: Cache coverage
      uses: actions/cache@v4
      with:
        path: coverage/
        key: ${{ runner.os }}-coverage-${{ hashFiles('pubspec.lock') }}
    - name: Create secrets.dart
      run: cp lib/src/config/secrets.dart.example lib/src/config/secrets.dart
      shell: bash
    - run: flutter test ${{ matrix.shard.path }} --coverage --machine

  build-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - target: apk --target-platform android-arm,android-arm64,android-x64
          os: ubuntu-latest
        - target: ios
          os: macos-13
        - target: linux
          os: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: subosito/flutter-action@v2
      with: {cache: true}
    - name: Install Linux build dependencies
      if: matrix.target == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev
    - name: Create secrets.dart
      run: cp lib/src/config/secrets.dart.example lib/src/config/secrets.dart
      shell: bash
    - run: flutter pub get
    - run: flutter build ${{ matrix.target }} --release --no-pub

  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: subosito/flutter-action@v2
      with: {cache: true}
    - run: dart doc-update . || echo "docs not configured"
